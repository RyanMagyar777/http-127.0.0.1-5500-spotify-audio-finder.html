<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Audio Finder ‚Äî Spotify</title>
<style>
  :root{--bg:#0b0f14;--panel:#111722;--panel2:#0e1625;--border:#1e2a3b;--text:#e8f1f8;--muted:#9db1c6;--accent:#1db954;--ok:#78f0b4;--danger:#ff7a7a;--chip:#1a2333}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0f16,#0a1119 40%,#0b0f14);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  header h1{font-size:18px;margin:0}
  .badge{padding:4px 8px;border:1px solid #253247;border-radius:999px;background:var(--chip);color:#d9f2ff;font-size:12px}
  main{display:grid;grid-template-columns:380px 1fr;gap:14px;padding:14px}
  @media (max-width:1100px){main{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
  .panel h2{font-size:13px;text-transform:uppercase;letter-spacing:.12em;color:#a9bfd1;margin:0;padding:12px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#101722,#0e1520)}
  .section{padding:12px;border-bottom:1px solid #1b2433}
  .section:last-child{border-bottom:none}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="text"],input[type="url"],input[type="number"],select{
    flex:1;min-width:140px;background:#0c1320;border:1px solid #22324a;color:var(--text);padding:10px 12px;border-radius:10px;outline:none
  }
  input:focus,select:focus{border-color:#2e86a5;box-shadow:0 0 0 3px rgba(29,185,84,.2)}
  .btn{background:#122033;border:1px solid #2a3b56;color:#d6f0ff;padding:10px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{filter:brightness(1.06)}
  .btn.primary{background:linear-gradient(180deg,#2ac86d,#1db954);border-color:#179846}
  .btn.ghost{background:transparent}
  .btn.danger{background:#301616;border-color:#663c3c;color:#ffd4d4}
  .mini{font-size:12px;color:var(--muted)}
  .tools{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid #172033;background:var(--panel2);flex-wrap:wrap}
  .list{overflow:auto;flex:1}
  .track{display:grid;grid-template-columns:24px auto 1fr auto;gap:10px;align-items:center;padding:8px 12px;border-bottom:1px solid #172033}
  .track:hover{background:#0c1421}
  .track.active{background:#0f1a2b;border-left:3px solid var(--accent)}
  .drag{cursor:grab; user-select:none; color:#8aa0b3; text-align:center}
  .srcTag{font-size:11px;color:#9bb0c3;background:#0e1a2c;border:1px solid #22324a;padding:2px 6px;border-radius:999px}
  .right{display:flex;align-items:center;gap:8px}
  .msg-ok{color:var(--ok)} .msg-err{color:var(--danger)}
  a.link{color:#9ad9ff;text-decoration:none}
  a.link:hover{text-decoration:underline}

  /* Notes drawer */
  .drawer{position:fixed;top:0;right:-420px;width:400px;height:100vh;background:#0f1726;border-left:1px solid #203049;box-shadow:-10px 0 30px rgba(0,0,0,.3);transition:right .25s;padding:16px;z-index:50}
  .drawer.open{right:0}
  .drawer h3{margin:0 0 8px}
  .drawer textarea{width:100%;height:45vh;background:#0a1220;color:#e9f3ff;border:1px solid #22324a;border-radius:10px;padding:10px}
  .drawer .log{margin-top:10px;max-height:38vh;overflow:auto;border:1px solid #22324a;border-radius:10px;padding:8px;background:#0c1422}
  .drawer .log .item{border-bottom:1px dashed #25324a;padding:6px 0}
  .drawer .log .item:last-child{border-bottom:none}
</style>
</head>
<body>
<header>
  <h1>üéß Audio Finder ‚Äî Spotify</h1>
  <span class="badge">PKCE login (local)</span>
  <span class="badge">Shuffle + Drag reorder</span>
  <span class="badge">Random start (24s‚Üí15m)</span>
  <button class="btn" id="openNotes" style="margin-left:auto">‚úçÔ∏è Update Notes</button>
</header>

<main>
  <!-- LEFT: Spotify connect + Add by URI -->
  <div class="panel">
    <h2>Spotify</h2>

    <div class="section">
      <div class="row">
        <input id="clientId" type="text" placeholder="Your Spotify Client ID (from dashboard)" />
        <input id="redirectUri" type="url" value="http://127.0.0.1:5500/" />
      </div>
      <div class="row">
        <button class="btn primary" id="connectBtn">Connect to Spotify</button>
        <button class="btn ghost" id="logoutBtn">Logout</button>
        <span id="authStatus" class="mini"></span>
      </div>
      <small class="mini">Scopes: streaming, user-read-playback-state, user-modify-playback-state, playlist-read-private, playlist-read-collaborative</small>
    </div>

    <div class="section">
      <div class="row">
        <input id="uri" type="text" placeholder="Paste Spotify URI or link (track/album/playlist/show/episode)" />
        <button class="btn" id="addUriBtn">Add</button>
      </div>
      <small class="mini">Examples: <code>spotify:track:‚Ä¶</code> ‚Ä¢ <code>spotify:album:‚Ä¶</code> ‚Ä¢ <code>https://open.spotify.com/playlist/‚Ä¶</code></small>
      <div id="addStatus" class="mini" style="margin-top:6px"></div>
    </div>

    <div class="section">
      <div class="row">
        <span class="mini">Search (optional)</span>
        <input id="searchQ" type="text" placeholder="Artist, album, playlist, show, episode‚Ä¶" />
        <select id="searchType">
          <option value="track">Tracks</option>
          <option value="album">Albums</option>
          <option value="playlist">Playlists</option>
          <option value="artist">Artists</option>
          <option value="show">Shows</option>
          <option value="episode">Episodes</option>
        </select>
        <button class="btn" id="searchBtn">Search</button>
      </div>
      <div id="searchStatus" class="mini" style="margin-top:6px"></div>
    </div>

    <div class="section">
      <div class="row">
        <span class="mini">Duration gate (min‚Üímax)</span>
        <input id="gateMin" type="text" placeholder="e.g., 0:24 or 24s" style="width:120px">
        <input id="gateMax" type="text" placeholder="e.g., 15m" style="width:120px">
        <button class="btn" id="applyGate">Apply to next add</button>
        <button class="btn ghost" id="clearGate">Clear</button>
      </div>
      <small class="mini">Accepts <code>mm:ss</code>, <code>h:mm:ss</code>, <code>30s</code>, <code>15m</code>, <code>1h</code>, or plain minutes (e.g. <code>10</code>).</small>
    </div>

    <div class="section">
      <button class="btn danger" id="clearBtn">Clear playlist</button>
      <button class="btn" id="updateBtn">üîÑ Show Update Button</button>
      <div id="updateInfo" class="mini" style="margin-top:6px"></div>
    </div>
  </div>

  <!-- RIGHT: Player + tools + playlist -->
  <div class="panel player">
    <h2>Player</h2>

    <div class="section">
      <div class="row">
        <button class="btn" id="prevBtn">‚èÆ</button>
        <button class="btn" id="playPauseBtn">‚ñ∂Ô∏è</button>
        <button class="btn" id="nextBtn">‚è≠</button>
        <button class="btn" id="randomTimeBtn" title="Jump to a random time (¬± random)">üé≤ Random Time</button>
        <label class="mini">Random Start Range
          <input id="randMin" type="text" placeholder="24s" style="width:80px">
          <input id="randMax" type="text" placeholder="15m" style="width:80px">
          <label class="mini">Enable <input id="randToggle" type="checkbox" checked></label>
        </label>
        <button class="btn" id="shuffleBtn" title="Shuffle playback">üîÄ</button>
        <span id="nowLabel" class="mini" style="margin-left:auto"></span>
      </div>
      <div class="row" style="margin-top:8px">
        <span class="mini" id="curTime">0:00</span>
        <input id="seek" type="range" min="0" max="1000" value="0" />
        <span class="mini" id="durTime">0:00</span>
        <span class="mini">Vol</span><input id="vol" type="range" min="0" max="1" step="0.01" value="1" style="width:140px"/>
      </div>
      <div class="mini" id="playerStatus" style="margin-top:6px"></div>
    </div>

    <div class="tools">
      <button class="btn" id="shuffleOrderBtn">üîÄ Shuffle Order</button>
      <span class="mini">Playlist Dur Filter (min‚Üímax)</span>
      <input id="listMin" type="text" placeholder="0:00" style="width:90px">
      <input id="listMax" type="text" placeholder="15:00" style="width:90px">
      <button class="btn" id="listFilter">Apply</button>
      <button class="btn ghost" id="listClear">Clear</button>
    </div>

    <div class="list" id="playlist">
      <div class="mini" style="padding:10px 12px;">Playlist empty. Paste a Spotify URI or link above.</div>
    </div>
  </div>
</main>

<!-- Notes drawer -->
<div class="drawer" id="notesDrawer">
  <h3>‚úçÔ∏è Update Notes</h3>
  <div class="mini" id="notesInfo" style="margin-bottom:6px;"></div>
  <textarea id="notesArea" placeholder="Type what changed or what you added‚Ä¶"></textarea>
  <div class="row" style="margin-top:8px">
    <button class="btn primary" id="saveNotes">Save note</button>
    <button class="btn" id="clearNotes">Clear</button>
  </div>
  <div class="log" id="notesLog"></div>
</div>

<!-- Spotify SDK (loads when needed) -->
<script>
/* =========================
   Small helper utilities
========================= */
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const fmt = s => { if(!isFinite(s)||s<0)s=0; const m=Math.floor(s/60), ss=String(Math.floor(s%60)).padStart(2,'0'); return m+':'+ss; };
// Flexible duration parser: "mm:ss", "h:mm:ss", "30s", "15m", "1h", "10" (minutes)
function parseDur(str){
  if(!str) return null;
  const t=str.trim().toLowerCase();
  if(/^\d+:\d{1,2}:\d{2}$/.test(t)){ const [h,m,s]=t.split(':').map(Number); return h*3600+m*60+s; }
  if(/^\d{1,2}:\d{2}$/.test(t)){ const [m,s]=t.split(':').map(Number); return m*60+s; }
  if(/^\d+h$/.test(t)) return parseInt(t)*3600;
  if(/^\d+m$/.test(t)) return parseInt(t)*60;
  if(/^\d+s$/.test(t)) return parseInt(t);
  if(/^\d+$/.test(t))  return parseInt(t)*60;
  return null;
}

/* =========================
   App state
========================= */
let token=null, me=null, deviceId=null, premium=false, sdkReady=false;
let tracks=[]; // {id,title,artist,duration,uri,preview,source:'spotify'}
let idx=-1, shufflePlayback=false;
let gate=null; // {minSec?,maxSec?} applied when adding new URIs
let listGate=null; // playlist filter min/max
let usingSDK=false; // true if Web Playback SDK device is active

/* =========================
   PKCE Auth (browser-only)
========================= */
async function sha256(str){ const enc=new TextEncoder().encode(str); const hash=await crypto.subtle.digest('SHA-256', enc); return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function randStr(len=64){ const a=new Uint8Array(len); crypto.getRandomValues(a); return Array.from(a).map(v=>("0"+(v&0xff).toString(16)).slice(-2)).join(''); }
function getParams(){ return Object.fromEntries(new URLSearchParams(location.search)); }
function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
function load(key){ try{ return JSON.parse(localStorage.getItem(key)); }catch{return null;} }
function clearAuth(){ token=null; me=null; premium=false
        <input id="randMax" type="text" value="15:00" style="width:100px">
        <label class="mini">Enable <input id="randToggle" type="checkbox" checked></label>
      </div>

      <div id="addStatus" class="mini" style="margin-top:6px"></div>
    </div>

    <div class="section">
      <button class="btn danger" id="clearBtn">Clear playlist</button>
    </div>
  </div>

  <!-- RIGHT: Player + Playlist -->
  <div class="panel player">
    <h2>Player</h2>
    <div class="now">
      <div class="title" id="nowTitle">Not connected</div>
      <div class="mini" id="nowMeta"></div>

      <div class="controls">
        <button class="btn" id="prevBtn">‚èÆ</button>
        <button class="btn" id="playPauseBtn">‚ñ∂Ô∏è</button>
        <button class="btn" id="nextBtn">‚è≠</button>
        <button class="btn" id="randomTimeBtn" title="Jump to random time">üé≤ Random Time</button>
        <label class="mini">Auto random on Next <input id="autoRandNext" type="checkbox" checked></label>
        <button class="btn" id="shuffleBtn" title="Shuffle playback">üîÄ</button>
        <div class="vol"><span class="mini">Vol</span><input id="vol" type="range" min="0" max="1" step="0.01" value="1" /></div>
      </div>

      <div class="progress">
        <span class="mini" id="curTime">0:00</span>
        <input id="seek" type="range" min="0" max="1000" value="0" />
        <span class="mini" id="durTime">0:00</span>
      </div>
    </div>

    <div class="tools">
      <button class="btn" id="shuffleOrderBtn">üîÄ Shuffle Order</button>
      <span class="mini">Drag to reorder your custom queue</span>
    </div>

    <div class="list" id="playlist">
      <div class="mini" style="padding:10px 12px;">Playlist empty. Add a Spotify URI, then drag the ‚ãÆ‚ãÆ handle to reorder.</div>
    </div>
  </div>
</main>

<!-- Update Notes drawer -->
<div class="drawer" id="notesDrawer">
  <h3>‚úçÔ∏è Update Notes</h3>
  <textarea id="notesArea" placeholder="Type what changed‚Ä¶"></textarea>
  <div class="row" style="margin-top:8px">
    <button class="btn primary" id="saveNotes">Save note</button>
    <button class="btn" id="clearNotes">Clear</button>
  </div>
  <div class="log" id="notesLog"></div>
</div>

<!-- Spotify SDK -->
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>
(function(){
  // ---------- Helpers ----------
  const $ = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];
  const fmt = s => { if(!isFinite(s)||s<0)s=0; const m=Math.floor(s/60), ss=String(Math.floor(s%60)).padStart(2,'0'); return m+':'+ss; };
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  // Flexible duration parser: "mm:ss", "h:mm:ss", "45m", "1h", "3600s", "90"
  function parseDurFlex(str){
    if(!str) return null;
    const t=str.trim().toLowerCase();
    if(/^\d+:\d{2}:\d{2}$/.test(t)){ const [h,m,s]=t.split(':').map(Number); return (h*3600+m*60+s)*1000; }
    if(/^\d{1,2}:\d{2}$/.test(t)){ const [m,s]=t.split(':').map(Number); return (m*60+s)*1000; }
    if(/^\d+h$/.test(t)) return parseInt(t)*3600*1000;
    if(/^\d+m$/.test(t)) return parseInt(t)*60*1000;
    if(/^\d+s$/.test(t)) return parseInt(t)*1000;
    if(/^\d+$/.test(t)) return parseInt(t)*60*1000; // plain minutes
    return null;
  }

  function parseSpotifyURI(text){
    if(!text) return null;
    const s=text.trim();
    if(s.startsWith('spotify:')) return s;
    try{
      const u=new URL(s);
      if(u.hostname.includes('open.spotify.com')){
        const parts=u.pathname.split('/').filter(Boolean); // e.g., /track/{id}
        if(parts.length>=2){ return `spotify:${parts[0]}:${parts[1]}`; }
      }
    }catch{}
    return null;
  }

  // ---------- UI refs ----------
  const clientId=$('#clientId'), redirectUri=$('#redirectUri'), connectBtn=$('#connectBtn');
  const accessToken=$('#accessToken'), useTokenBtn=$('#useTokenBtn'), transferBtn=$('#transferBtn');
  const authStatus=$('#authStatus');

  const rename=$('#rename'), uri=$('#uri'), addUriBtn=$('#addUriBtn'), addStatus=$('#addStatus');
  const clipMin=$('#clipMin'), clipMax=$('#clipMax');
  const randMin=$('#randMin'), randMax=$('#randMax'), randToggle=$('#randToggle');

  const nowTitle=$('#nowTitle'), nowMeta=$('#nowMeta'), curTime=$('#curTime'), durTime=$('#durTime');
  const prevBtn=$('#prevBtn'), playPauseBtn=$('#playPauseBtn'), nextBtn=$('#nextBtn'), randomTimeBtn=$('#randomTimeBtn'), autoRandNext=$('#autoRandNext');
  const seek=$('#seek'), vol=$('#vol'), shuffleBtn=$('#shuffleBtn'), shuffleOrderBtn=$('#shuffleOrderBtn'), playlistEl=$('#playlist');

  const openNotes=$('#openNotes'), notesDrawer=$('#notesDrawer'), notesArea=$('#notesArea'), saveNotes=$('#saveNotes'), clearNotes=$('#clearNotes'), notesLog=$('#notesLog');
  $('#clearBtn').addEventListener('click',()=>{ tracks=[]; idx=-1; render(); });

  // ---------- State ----------
  let token=null, deviceId=null, player=null;
  let tracks=[]; // {uri, title, artist, duration_ms, id, customName?}
  let idx=-1;
  let shufflePlayback=false;

  // ---------- Notes ----------
  function refreshNotes(){
    const arr = JSON.parse(localStorage.getItem('spotifyFinderNotes')||'[]');
    notesLog.innerHTML = arr.map(n=> `<div class="item"><div class="mini">${new Date(n.t).toLocaleString()}</div><div>${escapeHTML(n.txt)}</div></div>`).join('');
  }
  function escapeHTML(s){return (s||'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));}
  openNotes.addEventListener('click',()=>{ notesDrawer.classList.toggle('open'); refreshNotes(); });
  saveNotes.addEventListener('click',()=>{ const txt=notesArea.value.trim(); if(!txt) return; const arr=JSON.parse(localStorage.getItem('spotifyFinderNotes')||'[]'); arr.unshift({t:Date.now(),txt}); localStorage.setItem('spotifyFinderNotes', JSON.stringify(arr)); notesArea.value=''; refreshNotes(); });
  clearNotes.addEventListener('click',()=> notesArea.value='');

  // ---------- Auth (PKCE or pasted token) ----------
  // Save & restore fields
  clientId.value = localStorage.getItem('sf_clientId') || '';
  redirectUri.value = localStorage.getItem('sf_redirectUri') || '';
  accessToken.value = localStorage.getItem('sf_accessToken') || '';

  function setStatus(el, msg, ok=true){ el.innerHTML = ok ? `<span class="ok">${msg}</span>` : `<span class="err">${msg}</span>`; }

  async function pkceStart(){
    const cid=clientId.value.trim(), red=redirectUri.value.trim();
    if(!cid || !red){ setStatus(authStatus,'Client ID and Redirect URI required.', false); return; }
    localStorage.setItem('sf_clientId', cid);
    localStorage.setItem('sf_redirectUri', red);

    // PKCE
    const verifier=Array.from(crypto.getRandomValues(new Uint8Array(64))).map(b=>('0'+b.toString(16)).slice(-2)).join('');
    const data=new TextEncoder().encode(verifier);
    const digest=await crypto.subtle.digest('SHA-256', data);
    const challenge=btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    sessionStorage.setItem('sf_verifier', verifier);

    const params=new URLSearchParams({
      response_type:'code',
      client_id: cid,
      code_challenge_method:'S256',
      code_challenge: challenge,
      redirect_uri: red,
      scope:'streaming user-read-playback-state user-modify-playback-state'
    });
    window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
  }
  connectBtn.addEventListener('click', pkceStart);

  async function pkceFinish(){
    const code=new URLSearchParams(location.search).get('code');
    if(!code) return;
    const verifier=sessionStorage.getItem('sf_verifier');
    const cid=clientId.value.trim(), red=redirectUri.value.trim();
    try{
      const body=new URLSearchParams({
        grant_type:'authorization_code',
        code, redirect_uri:red, client_id:cid, code_verifier:verifier
      });
      const r=await fetch('https://accounts.spotify.com/api/token',{method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body});
      const j=await r.json();
      if(j.access_token){
        token=j.access_token;
        localStorage.setItem('sf_accessToken', token);
        accessToken.value = token;
        setStatus(authStatus, 'Connected with PKCE.');
        history.replaceState({}, document.title, location.pathname); // clean ?code=
        await initPlayer();
      }else{
        setStatus(authStatus, 'PKCE token error.', false);
      }
    }catch(e){ setStatus(authStatus, 'PKCE exchange failed.', false); }
  }

  useTokenBtn.addEventListener('click', async ()=>{
    const t=accessToken.value.trim();
    if(!t){ setStatus(authStatus,'Paste an access token first.',false); return; }
    token=t; localStorage.setItem('sf_accessToken', t);
    setStatus(authStatus,'Token stored. Initializing player‚Ä¶');
    await initPlayer();
  });

  // ---------- Spotify Player ----------
  window.onSpotifyWebPlaybackSDKReady = async () => {
    if(localStorage.getItem('sf_accessToken')){
      token = localStorage.getItem('sf_accessToken');
      await initPlayer();
    }
  };

  async function initPlayer(){
    if(!token){ setStatus(authStatus,'No token yet.', false); return; }
    if(player){ try{ await player.disconnect(); }catch{} }
    player = new Spotify.Player({
      name: 'Audio Finder (Web)',
      getOAuthToken: cb => cb(token),
      volume: 0.8
    });
    player.addListener('ready', ({ device_id }) => { deviceId = device_id; setStatus(authStatus, `Player ready (device ${device_id}). Click ‚ÄúMake this device active‚Äù.`); });
    player.addListener('not_ready', ({ device_id }) => { if(deviceId===device_id) deviceId=null; setStatus(authStatus, `Device ${device_id} went offline.`, false); });
    player.addListener('player_state_changed', state => {
      if(!state) return;
      const cur = state.track_window.current_track;
      nowTitle.textContent = cur ? (cur.name || '‚Ä¶') : '‚Äî';
      nowMeta.innerHTML = cur ? [cur.artists?.map(a=>a.name).join(', '), 'Spotify'].filter(Boolean).join(' ‚Ä¢ ') : '';
      const pos = state.position||0, dur = state.duration||0;
      seek.value = dur ? Math.floor((pos/dur)*1000) : 0;
      curTime.textContent = fmt(pos/1000);
      durTime.textContent = fmt(dur/1000);
      playPauseBtn.textContent = state.paused ? '‚ñ∂Ô∏è' : '‚è∏';
    });
    player.addListener('initialization_error', e=> setStatus(authStatus, 'Init error: '+e.message, false));
    player.addListener('authentication_error', e=> setStatus(authStatus, 'Auth error: '+e.message, false));
    player.addListener('account_error', e=> setStatus(authStatus, 'Account error: '+e.message, false));
    await player.connect();
  }

  async function api(path, method='GET', body=null){
    if(!token) throw new Error('No token');
    const r=await fetch(`https://api.spotify.com/v1${path}`,{
      method, headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
      body: body? JSON.stringify(body): null
    });
    if(r.status===204) return {};
    const j=await r.json();
    if(!r.ok) throw new Error(j.error?.message||('HTTP '+r.status));
    return j;
  }

  transferBtn.addEventListener('click', async ()=>{
    if(!deviceId){ setStatus(authStatus,'Player not ready yet.', false); return; }
    try{
      await api('/me/player','PUT',{ device_ids:[deviceId], play:true });
      setStatus(authStatus,'Playback transferred here.');
    }catch(e){ setStatus(authStatus,'Transfer failed: '+e.message, false); }
  });

  // ---------- Playlist model / render ----------
  function render(){
    playlistEl.innerHTML='';
    if(!tracks.length){
      const n=document.createElement('div'); n.className='mini'; n.style.padding='10px 12px'; n.textContent='Playlist empty. Add a Spotify URI, then drag the ‚ãÆ‚ãÆ handle to reorder.'; playlistEl.appendChild(n); return;
    }
    tracks.forEach((t,i)=>{
      const row=document.createElement('div'); row.className='track'+(i===idx?' active':''); row.draggable=true; row.dataset.index=i;

      const drag=document.createElement('div'); drag.className='drag'; drag.textContent='‚ãÆ‚ãÆ';
      const tag=document.createElement('span'); tag.className='srcTag'; tag.textContent='Spotify';

      const main=document.createElement('div');
      const title=document.createElement('div'); title.contentEditable=true; title.spellcheck=false; title.textContent=t.customName||t.title||'(untitled)';
      title.addEventListener('blur',()=>{ t.customName=title.textContent.trim(); });
      const meta=document.createElement('div'); meta.className='mini'; meta.textContent = [t.artist, t.duration_ms? fmt(t.duration_ms/1000):null].filter(Boolean).join(' ‚Ä¢ ');
      main.append(title,meta);

      const right=document.createElement('div'); right.className='right';
      const play=document.createElement('button'); play.className='btn'; play.textContent='‚ñ∂'; play.onclick=()=> playAt(i);
      const del=document.createElement('button'); del.className='btn'; del.textContent='‚úï'; del.onclick=()=>{ if(i===idx) idx=-1; tracks.splice(i,1); render(); };
      right.append(play,del);

      row.append(drag,tag,main,right);
      playlistEl.appendChild(row);
    });
    wireDnD();
  }

  function wireDnD(){
    playlistEl.querySelectorAll('.track').forEach(row=>{
      row.addEventListener('dragstart',e=>{ row.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain', row.dataset.index); });
      row.addEventListener('dragend',()=> row.classList.remove('dragging'));
      row.addEventListener('dragover',e=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; });
      row.addEventListener('drop',e=>{
        e.preventDefault(); const from=+e.dataTransfer.getData('text/plain'), to=+row.dataset.index;
        if(Number.isInteger(from)&&Number.isInteger(to)&&from!==to){
          const [it]=tracks.splice(from,1); tracks.splice(to,0,it);
          if(idx===from) idx=to; else if(from<idx && to>=idx) idx--; else if(from>idx && to<=idx) idx++;
          render();
        }
      });
    });
  }

  // ---------- Add by URI with duration gate ----------
  async function addSpotifyURI(){
    const raw=uri.value.trim(); const sp=parseSpotifyURI(raw);
    const custom = rename.value.trim();
    if(!sp){ setStatus(addStatus,'Invalid Spotify URI/URL.',false); return; }

    // parse duration gates
    const minMs = parseDurFlex(clipMin.value);
    const maxMs = parseDurFlex(clipMax.value);
    const gate = (minMs==null && maxMs==null) ? null : {minMs, maxMs};

    try{
      const [type,id] = sp.split(':').slice(1); // e.g., ['track','abc']
      if(type==='track'){
        const tr = await api(`/tracks/${id}`);
        const ok = matchGate(tr.duration_ms, gate);
        if(!ok){ setStatus(addStatus,'Track outside clip duration range.', false); return; }
        tracks.push({uri: tr.uri, id: tr.id, title: tr.name, artist: tr.artists.map(a=>a.name).join(', '), duration_ms: tr.duration_ms, customName: custom||''});
      }else if(type==='album'){
        const a = await api(`/albums/${id}`);
        let added=0;
        for(const tr of a.tracks.items){
          const full = tr; // durations available here
          if(matchGate(full.duration_ms, gate)){
            tracks.push({uri: full.uri, id: full.id, title: full.name, artist: full.artists.map(a=>a.name).join(', '), duration_ms: full.duration_ms, customName: custom||''});
            added++;
          }
        }
        if(!added) { setStatus(addStatus,'No album tracks inside range.', false); }
        else setStatus(addStatus,`Added ${added} album track(s).`);
      }else if(type==='playlist'){
        // Paginate playlist items (first 100)
        let added=0, next=`/playlists/${id}/tracks?limit=100`;
        while(next){
          const page = await api(next.replace('/v1',''));
          for(const it of page.items){
            const tr = it.track; if(!tr || tr.is_local) continue;
            if(matchGate(tr.duration_ms, gate)){
              tracks.push({uri: tr.uri, id: tr.id, title: tr.name, artist: tr.artists.map(a=>a.name).join(', '), duration_ms: tr.duration_ms, customName: custom||''});
              added++;
            }
          }
          next = page.next;
          if(added>=200) break; // safety limit
        }
        if(!added) { setStatus(addStatus,'No playlist tracks inside range.', false); }
        else setStatus(addStatus,`Added ${added} playlist track(s).`);
      }else{
        setStatus(addStatus,'Only track/album/playlist supported.', false); return;
      }

      rename.value=''; uri.value='';
      render();
      if(idx===-1 && tracks.length) { idx=0; await playAt(idx); }
    }catch(e){
      setStatus(addStatus, 'Add failed: '+e.message, false);
    }
  }
  addUriBtn.addEventListener('click', addSpotifyURI);

  function matchGate(durMs, gate){
    if(!gate) return true;
    const {minMs, maxMs} = gate;
    if(minMs!=null && durMs<minMs) return false;
    if(maxMs!=null && durMs>maxMs) return false;
    return true;
  }

  // ---------- Transport (using Web API to play on our device) ----------
  async function ensureActiveHere(){
    if(!deviceId){ throw new Error('Device not ready'); }
    // Try to transfer silently (won‚Äôt interrupt other devices if already here)
    try{ await api('/me/player','PUT',{device_ids:[deviceId], play:false}); }catch{}
  }

  async function playAt(i){
    if(i<0 || i>=tracks.length) return;
    idx=i; const queue = tracks.slice(i).map(t=>t.uri);
    await ensureActiveHere();

    // Start playback with our ordered URIs
    await api(`/me/player/play?device_id=${deviceId}`, 'PUT', { uris: queue });

    // Optional random seek after start
    if(randToggle.checked){
      await sleep(500); // small delay so playback starts
      await randomSeekWithinRange();
    }
  }

  prevBtn.addEventListener('click', async ()=>{
    if(idx<=0){ await api('/me/player/previous','POST'); idx=0; } else { idx--; await playAt(idx); }
  });
  nextBtn.addEventListener('click', async ()=>{
    if(idx<0){ if(tracks.length){ idx=0; await playAt(idx);} return; }
    if(idx < tracks.length-1){
      idx++;
      if(autoRandNext.checked){ await playAt(idx); }
      else{
        await ensureActiveHere();
        await api('/me/player/next','POST');
      }
    }else{
      // wrap
      idx=0; await playAt(idx);
    }
  });

  playPauseBtn.addEventListener('click', async ()=>{
    const st = await api('/me/player','GET').catch(()=>null);
    if(st && !st.is_playing) await api('/me/player/play','PUT');
    else await api('/me/player/pause','PUT');
  });

  seek.addEventListener('input', async ()=>{
    const st=await api('/me/player','GET').catch(()=>null);
    if(!st) return;
    const pos = st.item ? Math.floor((seek.value/1000)*st.item.duration_ms) : 0;
    await api(`/me/player/seek?position_ms=${pos}`,'PUT');
  });

  vol.addEventListener('input', async ()=>{
    const pct = Math.round(parseFloat(vol.value)*100);
    await api(`/me/player/volume?volume_percent=${pct}`,'PUT').catch(()=>{});
  });

  shuffleBtn.addEventListener('click', ()=>{
    shufflePlayback=!shufflePlayback;
    shuffleBtn.style.filter = shufflePlayback ? 'brightness(1.25)' : 'none';
  });

  // Random time jump (forward/back within your range, clamped to track)
  async function randomSeekWithinRange(){
    const st = await api('/me/player','GET').catch(()=>null);
    if(!st || !st.item) return;
    const dur = st.item.duration_ms;

    let lo = parseDurFlex(randMin.value); if(lo==null) lo=0;
    let hi = parseDurFlex(randMax.value); if(hi==null) hi=Math.min(dur, 15*60*1000);
    if(hi<lo) [lo,hi]=[hi,lo];
    const pos = clamp(Math.floor(Math.random()*(hi-lo)+lo), 0, dur-1000);
    await api(`/me/player/seek?position_ms=${pos}`,'PUT');
  }
  randomTimeBtn.addEventListener('click', randomSeekWithinRange);

  // Shuffle order of our local queue (drag already supported)
  function shuffleOrder(){
    if(tracks.length<2) return;
    for(let i=tracks.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [tracks[i],tracks[j]]=[tracks[j],tracks[i]]; }
    render();
  }
  shuffleOrderBtn.addEventListener('click', shuffleOrder);

  // ---------- Keyboard ----------
  window.addEventListener('keydown',async e=>{
    if(e.target.matches('input,textarea')) return;
    if(e.code==='Space'){ e.preventDefault(); playPauseBtn.click(); }
    if(e.code==='ArrowRight'){ nextBtn.click(); }
    if(e.code==='ArrowLeft'){ prevBtn.click(); }
    if(e.key==='r'){ randomTimeBtn.click(); }
  });

  // ---------- Boot: finish PKCE if returned with ?code= ----------
  pkceFinish();

})();
</script>
</body>
</html>
